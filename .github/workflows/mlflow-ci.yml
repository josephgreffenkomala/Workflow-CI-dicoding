name: MLflow CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'MLProject/**'
      - '.github/workflows/mlflow-ci.yml'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      n_estimators:
        description: 'Number of trees in the forest'
        required: false
        default: '100'
      max_depth:
        description: 'Maximum depth of the tree'
        required: false
        default: '10'

jobs:
  train-model:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Conda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.10'
        activate-environment: base
        miniconda-version: "latest"
        
    - name: Install MLflow
      shell: bash -el {0}
      run: |
        pip install mlflow
        
    - name: Run MLflow Project
      shell: bash -el {0}
      run: |
        cd MLProject
        mlflow run . \
          -P n_estimators=${{ github.event.inputs.n_estimators || '100' }} \
          -P max_depth=${{ github.event.inputs.max_depth || '10' }}
        
    - name: Check artifacts
      run: |
        cd MLProject
        ls -la
        echo "Checking if artifacts exist..."
        test -f "run_id.txt" && echo "✓ Run ID file created" || echo "✗ Run ID file missing"
        test -f "confusion_matrix.png" && echo "✓ Confusion matrix created" || echo "✗ Confusion matrix missing"
        test -f "feature_importance.png" && echo "✓ Feature importance created" || echo "✗ Feature importance missing"
        if [ -f "run_id.txt" ]; then
          echo "Run ID:"
          cat run_id.txt
        fi
        
    - name: Upload MLflow artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts
        path: |
          MLProject/mlruns/
          MLProject/run_id.txt
          MLProject/confusion_matrix.png
          MLProject/feature_importance.png
        retention-days: 30
        
    - name: Create model archive
      run: |
        cd MLProject/mlruns
        tar -czf ../../model-artifacts.tar.gz .
        
    - name: Upload model to GitHub Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: model-artifacts.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Save artifacts to repository
      run: |
        git config --global user.name "josephgreffenkomala"
        git config --global user.email "josephgreffenkomala@mail.ugm.ac.id"
        mkdir -p artifacts
        cp MLProject/confusion_matrix.png artifacts/ || true
        cp MLProject/feature_importance.png artifacts/ || true
        cp MLProject/run_id.txt artifacts/ || true
        git add artifacts/
        git diff --staged --quiet || git commit -m "Update training artifacts [skip ci]"
        git pull
        git push
      continue-on-error: true
